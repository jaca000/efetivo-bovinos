<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Monte do Pasto ‚Äî Dashboard Bovinos</title>
<style>
  :root{
    --bg:#f4f5f2; --card:#fff; --line:#ddd; --muted:#666;
    --ok:#2e7d32; --warn:#f57c00; --bad:#b00020;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);margin:0;padding:18px;color:#222}
  h1{margin:0 0 10px;font-size:18px}
  h2{margin:0 0 10px;font-size:15px}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  input[type="file"]{padding:8px;background:#fff;border:1px solid #ccc;border-radius:10px}
  .status{font-size:13px;color:var(--muted)}
  .cards{display:grid;grid-template-columns:1fr;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  table{border-collapse:collapse;width:100%;background:#fff}
  th,td{border:1px solid #ccc;padding:8px;text-align:center;font-size:13px}
  th{background:#eee;position:sticky;top:0}
  .ok{color:var(--ok);font-weight:900}
  .warn{color:var(--warn);font-weight:900}
  .bad{color:var(--bad);font-weight:900}
  .muted{color:var(--muted)}
  .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
  .pill{display:inline-block;padding:2px 10px;border:1px solid #bbb;border-radius:999px;background:#fafafa}
  .stackbar{height:10px;background:#eee;border-radius:999px;overflow:hidden;display:flex}
  .seg{height:100%}
  .g{background:#4caf50}
  .o{background:#ff9800}
  .r{background:#f44336}
  .left{text-align:left}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .alerts-wrap{display:flex;flex-direction:column;gap:6px}
  .alert-row{padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fafafa}
  .alert-row.bad{border-color:#f2b8c0;background:#fff5f6}
  .alert-row.warn{border-color:#ffd7a8;background:#fff8f0}
  .alert-row.ok{border-color:#bfe6c1;background:#f4fff5}
  .tag{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #bbb;background:#fff;margin-left:8px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-bottom:10px}
  .controls label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .controls input{
    padding:8px 10px;border-radius:10px;border:1px solid #ccc;background:#fff;
    font-size:13px;min-width:160px
  }
  .controls button{
    padding:9px 14px;border-radius:10px;border:1px solid #ccc;background:#eee;
    cursor:pointer;font-weight:700
  }
  .controls button:disabled{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>

<h1>Dashboard Bovinos ‚Äî Monitoriza√ß√£o (Alertas + Previs√£o de Sa√≠da)</h1>

<div class="bar">
  <input type="file" id="fileInput" accept=".csv,text/csv">
  <div class="status" id="status">Carrega o teu <b>efetivo_bovinos.csv</b></div>
</div>

<div class="cards">
  <div class="card">
    <h2>Alertas</h2>
    <div id="alerts" class="alerts-wrap"></div>
    <div class="small">
      Regras: üî• <b>Vermelho</b> se üî¥ ‚â• 15% (em animais com 2 pesagens) ¬∑ ‚ö†Ô∏è <b>Amarelo</b> se (üü°+üî¥) ‚â• 30% ¬∑ ‚úî caso contr√°rio.
    </div>
  </div>

  <div class="card">
    <h2>Previs√£o de Sa√≠da por Grupo</h2>

    <div class="controls">
      <div>
        <label>Peso alvo Machos (kg)</label>
        <input id="targetM" inputmode="numeric" value="620">
      </div>
      <div>
        <label>Peso alvo F√™meas (kg)</label>
        <input id="targetF" inputmode="numeric" value="520">
      </div>
      <button id="btnRecalc" disabled>Recalcular previs√£o</button>
      <div class="status" id="forecastStatus"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th class="left">Grupo</th>
          <th>M</th>
          <th>F</th>
          <th>Peso est. M (hoje)</th>
          <th>Peso est. F (hoje)</th>
          <th>GMD M (real)</th>
          <th>GMD F (real)</th>
          <th>GMD M (usado)</th>
          <th>GMD F (usado)</th>
          <th>Dias M ‚Üí alvo</th>
          <th>Data M</th>
          <th>Dias F ‚Üí alvo</th>
          <th>Data F</th>
          <th class="left">Estado</th>
        </tr>
      </thead>
      <tbody id="tbodyForecast"></tbody>
    </table>

    <div class="small">
      ‚Ä¢ ‚ÄúGMD real‚Äù = m√©dia do grupo (por sexo) usando apenas animais com <b>2 pesagens</b>.<br>
      ‚Ä¢ ‚ÄúGMD usado‚Äù = GMD real se existir; caso contr√°rio usa fallback conservador autom√°tico (<b>1.10 kg/dia</b>).<br>
      ‚Ä¢ ‚ÄúPeso est. hoje‚Äù usa o modelo por animal (GMD base + fatores sexo/maturidade + fator clima do per√≠odo).<br>
      ‚Ä¢ Datas s√£o previs√µes para planeamento.
    </div>
  </div>

  <div class="card">
    <h2>Resumo por Grupo</h2>
    <table>
      <thead>
        <tr>
          <th class="left">Grupo</th>
          <th>Animais</th>
          <th>M</th>
          <th>F</th>
          <th>Peso M (kg)</th>
          <th>Peso F (kg)</th>
          <th>GMD M real</th>
          <th>GMD F real</th>
          <th>Temp. m√©dia (¬∞C)</th>
          <th>Estado do grupo</th>
        </tr>
      </thead>
      <tbody id="tbodyGroups"></tbody>
    </table>
    <div class="small">
      ‚Ä¢ ‚ÄúGMD real‚Äù usa apenas animais com <b>2 pesagens</b> (crescimento observado).<br>
      ‚Ä¢ A barra üü¢üü°üî¥ conta apenas animais com hist√≥rico (2 pesagens).<br>
      ‚Ä¢ Meteorologia: temperatura m√©dia do per√≠odo desde a √∫ltima pesagem (Open-Meteo hist√≥rico). Se falhar, usa fator conservador.
    </div>
  </div>

  <div class="card">
    <h2>Detalhe por Animal</h2>
    <table>
      <thead>
        <tr>
          <th class="left">Animal</th>
          <th class="left">Grupo</th>
          <th>Sexo</th>
          <th>Peso atual</th>
          <th>Data peso</th>
          <th>Temp. per√≠odo</th>
          <th>Fator clima</th>
          <th>Peso estimado hoje</th>
          <th>Confian√ßa</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="tbodyAnimals"></tbody>
    </table>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const SITE = { lat: 38.17355612872988, lon: -7.986520046258665 };
const CONSERVATIVE_FALLBACK_GMD = 1.10; // kg/dia (quando n√£o h√° hist√≥rico real)

/* estado global (para recalcular previs√£o sem reimportar CSV) */
const APP_STATE = {
  loaded: false,
  todayUTC: null,
  groupsOut: [],
  groupAgg: {},
  gmdEstimativaGrupo: {},   // por grupo (misto) - usado na estima√ß√£o por animal
  gmdMediaGrupo: {},        // por grupo (misto) - para estado
  meteoByPeriod: new Map(), // "start|end" -> {tmean,factor}
};

/* ===================== REGRAS ===================== */
function performanceStatus(gmdInd, gmdMediaGrupo){
  if(!Number.isFinite(gmdInd) || !Number.isFinite(gmdMediaGrupo) || gmdMediaGrupo<=0) return ["‚Äî (sem hist√≥rico)","muted", 9, "none"];
  const r = gmdInd / gmdMediaGrupo;
  if(r >= 0.95) return ["üü¢ Normal","ok", 3, "g"];
  if(r >= 0.80) return ["üü° A vigiar","warn", 2, "o"];
  return ["üî¥ Atrasado","bad", 1, "r"];
}
function confidenceByDays(days){
  if(!Number.isFinite(days)) return ["‚Äî","muted"];
  if(days < 14) return ["Alta","ok"];
  if(days < 35) return ["M√©dia","warn"];
  return ["Baixa","bad"];
}
function factorSexo(sexo){ return (clean(sexo).toUpperCase()==="F") ? 0.92 : 1.00; }
function factorMaturidade(peso, sexo){
  const s = clean(sexo).toUpperCase();
  const limiar = (s==="F") ? 460 : 520;
  if(peso < limiar) return 1.00;
  if(peso < limiar + 60) return 0.90;
  return 0.80;
}

/* ===================== HELPERS ===================== */
function clean(s){ return String(s ?? "").trim(); }
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function parseNumber(x){
  x = clean(x);
  if(!x) return NaN;
  x = x.replace(",", ".");
  const n = parseFloat(x);
  return Number.isFinite(n) ? n : NaN;
}
function parseDatePT(s){
  s = clean(s);
  if(!s) return null;

  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    const dt = new Date(Date.UTC(y, mo-1, d));
    return Number.isFinite(dt.getTime()) ? dt : null;
  }

  m = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if(m){
    const d=+m[1], mo=+m[2], y=+m[3];
    const dt = new Date(Date.UTC(y, mo-1, d));
    return Number.isFinite(dt.getTime()) ? dt : null;
  }

  return null;
}
function fmtDate(d){
  if(!d) return "‚Äî";
  const dd = String(d.getUTCDate()).pad
  Start(2,"0");
  const mm = String(d.getUTCMonth()+1).padStart(2,"0");
  const yy = d.getUTCFullYear();
  return `${dd}-${mm}-${yy}`;
}
function addDaysUTC(dateUTC, days){
  const ms = dateUTC.getTime() + (days * 24*60*60*1000);
  return new Date(ms);
}
function daysBetweenUTC(a,b){
  if(!a || !b) return NaN;
  const ms = b.getTime() - a.getTime();
  return Math.floor(ms / (1000*60*60*24));
}
function detectDelimiter(text){
  const first = (text.split(/\r?\n/)[0] || "");
  const semi = (first.match(/;/g)||[]).length;
  const comma = (first.match(/,/g)||[]).length;
  return semi >= comma ? ";" : ",";
}
function isoDateUTC(d){
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth()+1).padStart(2,"0");
  const da = String(d.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function safeFloat(x, digits=2){
  return Number.isFinite(x) ? x.toFixed(digits) : "‚Äî";
}
function safeInt(x){
  return Number.isFinite(x) ? String(Math.max(0, Math.ceil(x))) : "‚Äî";
}

/* ===================== METEO (Open-Meteo hist√≥rico) ===================== */
const meteoCache = new Map(); // key start|end -> {tmean, factor}

function factorFromTempMean(t){
  if(!Number.isFinite(t)) return 0.95;
  if(t <= 20) return 1.00;
  if(t <= 25) return 0.95;
  if(t <= 30) return 0.85;
  return 0.70;
}

async function getTempMeanForPeriod(startUTC, endUTC){
  const start = isoDateUTC(startUTC);
  const end = isoDateUTC(endUTC);
  const key = `${start}|${end}`;
  if(meteoCache.has(key)) return meteoCache.get(key);

  const url =
    `https://archive-api.open-meteo.com/v1/archive` +
    `?latitude=${SITE.lat}&longitude=${SITE.lon}` +
    `&start_date=${start}&end_date=${end}` +
    `&daily=temperature_2m_mean` +
    `&timezone=auto`;

  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    const temps = j?.daily?.temperature_2m_mean || [];
    if(!temps.length){
      const pack = { tmean: NaN, factor: 0.95 };
      meteoCache.set(key, pack);
      return pack;
    }
    const tmean = temps.reduce((a,b)=>a+b,0)/temps.length;
    const pack = { tmean, factor: factorFromTempMean(tmean) };
    meteoCache.set(key, pack);
    return pack;
  }catch(err){
    const pack = { tmean: NaN, factor: 0.95 };
    meteoCache.set(key, pack);
    return pack;
  }
}

/* ===================== UI ===================== */
const statusEl = document.getElementById("status");
const tbodyGroups = document.getElementById("tbodyGroups");
const tbodyAnimals = document.getElementById("tbodyAnimals");
const tbodyForecast = document.getElementById("tbodyForecast");
const alertsEl = document.getElementById("alerts");

const targetMEl = document.getElementById("targetM");
const targetFEl = document.getElementById("targetF");
const btnRecalc = document.getElementById("btnRecalc");
const forecastStatusEl = document.getElementById("forecastStatus");

document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  btnRecalc.disabled = true;
  forecastStatusEl.textContent = "";
  const reader = new FileReader();
  reader.onload = ev => processCSV(ev.target.result);
  reader.readAsText(file);
});

btnRecalc.addEventListener("click", ()=>{
  if(!APP_STATE.loaded) return;
  renderForecast();
});

[targetMEl, targetFEl].forEach(el=>{
  el.addEventListener("input", ()=>{
    if(!APP_STATE.loaded) return;
    btnRecalc.disabled = false;
    forecastStatusEl.textContent = "Altera√ß√µes pendentes ‚Äî clica ‚ÄúRecalcular previs√£o‚Äù.";
  });
});

/* ===================== RENDER ===================== */
function renderGroupRow(g){
  const totalStatus = g.ok + g.warn + g.bad;
  const green = totalStatus ? (g.ok/totalStatus)*100 : 0;
  const orange = totalStatus ? (g.warn/totalStatus)*100 : 0;
  const red = totalStatus ? (g.bad/totalStatus)*100 : 0;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="left"><b>${escapeHtml(g.name)}</b></td>
    <td>${g.n}</td>
    <td>${g.m}</td>
    <td>${g.f}</td>
    <td>${Number.isFinite(g.avgPesoM) ? g.avgPesoM.toFixed(1) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgPesoF) ? g.avgPesoF.toFixed(1) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgGmdM) ? g.avgGmdM.toFixed(2) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgGmdF) ? g.avgGmdF.toFixed(2) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgTemp) ? g.avgTemp.toFixed(1) : "‚Äî"}</td>
    <td class="left">
      <div class="stackbar" title="Distribui√ß√£o do estado (apenas com 2 pesagens)">
        <div class="seg g" style="width:${green}%"></div>
        <div class="seg o" style="width:${orange}%"></div>
        <div class="seg r" style="width:${red}%"></div>
      </div>
      <div style="margin-top:6px" class="mono">
        üü¢ ${g.ok} &nbsp; üü° ${g.warn} &nbsp; üî¥ ${g.bad}
        <span class="muted"> (com hist√≥rico: ${totalStatus})</span>
        <span class="tag">risco ${(g.risk*100).toFixed(0)}%</span>
      </div>
    </td>
  `;
  tbodyGroups.appendChild(tr);
}

function renderAnimalRow(a){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="left">${escapeHtml(a.animal)}</td>
    <td class="left">${escapeHtml(a.grupo)}</td>
    <td>${escapeHtml(a.sexo)}</td>
    <td>${escapeHtml(a.pesoAtual)}</td>
    <td>${escapeHtml(a.dataAtual)}</td>
    <td>${escapeHtml(a.temp)}</td>
    <td>${a.fatorClima}</td>
    <td><b>${escapeHtml(a.estimado)}</b></td>
    <td class="${a.confClass}">${escapeHtml(a.conf)}</td>
    <td class="${a.estadoClass}">${escapeHtml(a.estado)}</td>
  `;
  tbodyAnimals.appendChild(tr);
}

function renderAlerts(groupsOut){
  alertsEl.innerHTML = "";

  const rows = [];
  for(const g of groupsOut){
    const total = g.ok + g.warn + g.bad;
    if(total === 0) continue;

    const pRed = g.bad / total;
    const pRisk = (g.bad + g.warn) / total;

    if(pRed >= 0.15){
      rows.push({level:"bad", text:`üî• ${g.name} ‚Äî ALERTA VERMELHO`, meta:`üî¥ ${(pRed*100).toFixed(0)}% | risco ${(pRisk*100).toFixed(0)}% | hist ${total}`});
    }else if(pRisk >= 0.30){
      rows.push({level:"warn", text:`‚ö†Ô∏è ${g.name} ‚Äî ALERTA AMARELO`, meta:`risco ${(pRisk*100).toFixed(0)}% | hist ${total}`});
    }
  }

  if(!rows.length){
    const div = document.createElement("div");
    div.className = "alert-row ok";
    div.innerHTML = `<b class="ok">‚úî Nenhum alerta ativo</b>`;
    alertsEl.appendChild(div);
    return;
  }

  rows.sort((a,b)=>{
    const la = a.level==="bad" ? 2 : 1;
    const lb = b.level==="bad" ? 2 : 1;
    if(lb!==la) return lb-la;
    return a.text.localeCompare(b.text);
  });

  for(const r of rows){
    const div = document.createElement("div");
    div.className = `alert-row ${r.level}`;
    div.innerHTML = `<b class="${r.level}">${escapeHtml(r.text)}</b><div class="small">${escapeHtml(r.meta)}</div>`;
    alertsEl.appendChild(div);
  }
}

function readTargets(){
  const tM = parseNumber(targetMEl.value);
  const tF = parseNumber(targetFEl.value);
  return {
    targetM: Number.isFinite(tM) && tM>0 ? tM : 620,
    targetF: Number.isFinite(tF) && tF>0 ? tF : 520
  };
}

function classifyReady(pesoEst, alvo){
  if(!Number.isFinite(pesoEst) || !Number.isFinite(alvo)) return ["‚Äî","muted"];
  if(pesoEst >= alvo) return ["Pronto ‚úÖ","ok"];
  if(pesoEst >= alvo - 20) return ["Quase l√° üü°","warn"];
  return ["Em engorda","muted"];
}

function calcDaysToTarget(pesoEst, alvo, gmd){
  if(!Number.isFinite(pesoEst) || !Number.isFinite(alvo) || !Number.isFinite(gmd) || gmd<=0) return NaN;
  if(pesoEst >= alvo) return 0;
  return (alvo - pesoEst) / gmd;
}

function pickGmdUsed(realGmd){
  return Number.isFinite(realGmd) && realGmd>0 ? realGmd : CONSERVATIVE_FALLBACK_GMD;
}

function renderForecast(){
  const { targetM, targetF } = readTargets();
  const todayUTC = APP_STATE.todayUTC;

  const rows = APP_STATE.groupsOut.map(g=>{
    const pM = g.avgEstM;
    const pF = g.avgEstF;

    const realM = g.avgGmdM;
    const realF = g.avgGmdF;

    const gmdUsedM = pickGmdUsed(realM);
    const gmdUsedF = pickGmdUsed(realF);

    const daysM = calcDaysToTarget(pM, targetM, gmdUsedM);
    const daysF = calcDaysToTarget(pF, targetF, gmdUsedF);

    const dateM = Number.isFinite(daysM) ? fmtDate(addDaysUTC(todayUTC, Math.ceil(daysM))) : "‚Äî";
    const dateF = Number.isFinite(daysF) ? fmtDate(addDaysUTC(todayUTC, Math.ceil(daysF))) : "‚Äî";

    const [stM, stMClass] = classifyReady(pM, targetM);
    const [stF, stFClass] = classifyReady(pF, targetF);

    const minDays = (() => {
      const a = Number.isFinite(daysM) ? daysM : Infinity;
      const b = Number.isFinite(daysF) ? daysF : Infinity;
      const m = Math.min(a,b);
      return (m === Infinity) ? NaN : m;
    })();

    let estadoTexto = "";
    let estadoClass = "muted";
    if(g.m>0 && g.f>0){
      if(stMClass==="ok" && stFClass==="ok"){ estadoTexto = "M e F prontos ‚úÖ"; estadoClass="ok"; }
      else if(stMClass==="ok" || stFClass==="ok"){ estadoTexto = "Parcialmente pronto (misto)"; estadoClass="warn"; }
      else if(stMClass==="warn" || stFClass==="warn"){ estadoTexto = "Quase l√° (misto)"; estadoClass="warn"; }
      else { estadoTexto = "Em engorda (misto)"; estadoClass="muted"; }
    }else if(g.m>0){
      estadoTexto = stM; estadoClass = stMClass;
    }else if(g.f>0){
      estadoTexto = stF; estadoClass = stFClass;
    }else{
      estadoTexto = "‚Äî"; estadoClass="muted";
    }

    return {
      name: g.name,
      m: g.m, f: g.f,
      pM, pF,
      realM, realF,
      gmdUsedM, gmdUsedF,
      daysM, daysF,
      dateM, dateF,
      minDays,
      estadoTexto,
      estadoClass
    };
  });

  rows.sort((a,b)=>{
    const aReady = (Number.isFinite(a.minDays) && a.minDays===0) ? 0 : 1;
    const bReady = (Number.isFinite(b.minDays) && b.minDays===0) ? 0 : 1;
    if(aReady !== bReady) return aReady - bReady;

    const am = Number.isFinite(a.minDays) ? a.minDays : Infinity;
    const bm = Number.isFinite(b.minDays) ? b.minDays : Infinity;
    if(am !== bm) return am - bm;

    return a.name.localeCompare(b.name);
  });

  tbodyForecast.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="left"><b>${escapeHtml(r.name)}</b></td>
      <td>${r.m}</td>
      <td>${r.f}</td>
      <td>${Number.isFinite(r.pM) ? r.pM.toFixed(1) : "‚Äî"}</td>
      <td>${Number.isFinite(r.pF) ? r.pF.toFixed(1) : "‚Äî"}</td>
      <td>${safeFloat(r.realM,2)}</td>
      <td>${safeFloat(r.realF,2)}</td>
      <td><b>${safeFloat(r.gmdUsedM,2)}</b></td>
      <td><b>${safeFloat(r.gmdUsedF,2)}</b></td>
      <td>${safeInt(r.daysM)}</td>
      <td>${escapeHtml(r.dateM)}</td>
      <td>${safeInt(r.daysF)}</td>
      <td>${escapeHtml(r.dateF)}</td>
      <td class="left ${r.estadoClass}"><b>${escapeHtml(r.estadoTexto)}</b></td>
    `;
    tbodyForecast.appendChild(tr);
  }

  forecastStatusEl.textContent = `Alvos: M ${targetM}kg ¬∑ F ${targetF}kg ¬∑ Fallback conservador: ${CONSERVATIVE_FALLBACK_GMD.toFixed(2)} kg/dia (autom√°tico)`;
  btnRecalc.disabled = true;
}

/* ===================== MAIN ===================== */
async function processCSV(csvText){
  tbodyGroups.innerHTML = "";
  tbodyAnimals.innerHTML = "";
  tbodyForecast.innerHTML = "";
  alertsEl.innerHTML = "";
  meteoCache.clear();

  APP_STATE.loaded = false;
  APP_STATE.groupsOut = [];
  APP_STATE.groupAgg = {};
  APP_STATE.gmdEstimativaGrupo = {};
  APP_STATE.gmdMediaGrupo = {};

  const delim = detectDelimiter(csvText);
  const lines = csvText.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(lines.length < 2){
    alert("CSV vazio ou inv√°lido.");
    return;
  }

  const now = new Date();
  const todayUTC = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
  APP_STATE.todayUTC = todayUTC;

  const header = lines[0].split(delim).map(clean);
  const idx = (name) => header.indexOf(name);

  const i_animal = idx("animal_id") >= 0 ? idx("animal_id") : 0;
  const i_sexo   = idx("sexo") >= 0 ? idx("sexo") : 2;
  const i_grupo  = idx("grupo") >= 0 ? idx("grupo") : 3;
  const i_dant   = idx("data_peso_anterior") >= 0 ? idx("data_peso_anterior") : 4;
  const i_pant   = idx("peso_anterior") >= 0 ? idx("peso_anterior") : 5;
  const i_datual = idx("data_peso_atual") >= 0 ? idx("data_peso_atual") : 6;
  const i_patual = idx("peso_atual") >= 0 ? idx("peso_atual") : 7;

  const rows = [];
  const gmdIndSamples = {}; // grupo -> [gmdInd]

  for(let li=1; li<lines.length; li++){
    const cols = lines[li].split(delim);

    const animal = clean(cols[i_animal]) || "‚Äî";
    const sexo   = clean(cols[i_sexo]).toUpperCase() || "‚Äî";
    const grupo  = clean(cols[i_grupo]) || "‚Äî";

    const dAnt   = parseDatePT(cols[i_dant]);
    const pAnt   = parseNumber(cols[i_pant]);
    const dAtual = parseDatePT(cols[i_datual]);
    const pAtual = parseNumber(cols[i_patual]);

    let gmdInd = NaN;
    if(dAnt && dAtual && Number.isFinite(pAnt) && Number.isFinite(pAtual)){
      const d = daysBetweenUTC(dAnt, dAtual);
      if(Number.isFinite(d) && d > 0){
        gmdInd = (pAtual - pAnt) / d;
        if(Number.isFinite(gmdInd)){
          (gmdIndSamples[grupo] ||= []).push(gmdInd);
        }
      }
    }

    rows.push({animal, sexo, grupo, dAnt, pAnt, dAtual, pAtual, gmdInd});
  }

  const gmdMediaGrupo = {};
  for(const r of rows){
    const g = r.grupo || "‚Äî";
    if(gmdMediaGrupo[g] == null){
      const arr = gmdIndSamples[g] || [];
      gmdMediaGrupo[g] = arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : NaN;
    }
  }
  APP_STATE.gmdMediaGrupo = gmdMediaGrupo;

  const gmdEstimativaGrupo = {};
  for(const r of rows){
    const g = r.grupo || "‚Äî";
    if(gmdEstimativaGrupo[g] == null){
      const arr = gmdIndSamples[g] || [];
      gmdEstimativaGrupo[g] = arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : CONSERVATIVE_FALLBACK_GMD;
    }
  }
  APP_STATE.gmdEstimativaGrupo = gmdEstimativaGrupo;

  statusEl.innerHTML = `Separador: <b>${delim}</b> ¬∑ Linhas: <b>${rows.length}</b> ¬∑ A pedir meteorologia‚Ä¶`;

  const periodKeys = new Set();
  for(const r of rows){
    if(r.dAtual){
      periodKeys.add(`${isoDateUTC(r.dAtual)}|${isoDateUTC(todayUTC)}`);
    }
  }

  await Promise.all([...periodKeys].map(async key=>{
    const [s,e] = key.split("|");
    const sD = new Date(Date.UTC(+s.slice(0,4), +s.slice(5,7)-1, +s.slice(8,10)));
    const eD = new Date(Date.UTC(+e.slice(0,4), +e.slice(5,7)-1, +e.slice(8,10)));
    await getTempMeanForPeriod(sD, eD);
  }));

  const animalsOut = [];
  const groupAgg = {};

  let okRows=0, badRows=0;

  for(const r of rows){
    const hasAtual = r.dAtual && Number.isFinite(r.pAtual);
    if(!hasAtual){
      badRows++;
      animalsOut.push({
        sortKey: 99,
        animal:r.animal, grupo:r.grupo, sexo:r.sexo,
        pesoAtual:"‚Äî", dataAtual:"‚Äî",
        temp:"‚Äî", fatorClima:`<span class="pill">‚Äî</span>`,
        estimado:"‚Äî",
        conf:"‚Äî", confClass:"muted",
        estado:"‚Äî", estadoClass:"muted",
        bucket:"none",
        estKg: NaN
      });
      continue;
    }

    const daysSince = daysBetweenUTC(r.dAtual, todayUTC);
    const [conf, confClass] = confidenceByDays(daysSince);

    const meteo = await getTempMeanForPeriod(r.dAtual, todayUTC);
    const fc = meteo.factor;

    const gmdBase = Number.isFinite(r.gmdInd) ? r.gmdInd : (gmdEstimativaGrupo[r.grupo] ?? CONSERVATIVE_FALLBACK_GMD);
    const gmdFinal = gmdBase * factorSexo(r.sexo) * factorMaturidade(r.pAtual, r.sexo) * fc;
    const estKg = r.pAtual + (gmdFinal * daysSince);

    const [estado, estadoClass, estadoSort, bucket] = performanceStatus(r.gmdInd, gmdMediaGrupo[r.grupo]);

    okRows++;

    animalsOut.push({
      sortKey: estadoSort,
      animal:r.animal, grupo:r.grupo, sexo:r.sexo,
      pesoAtual:`${r.pAtual.toFixed(1)} kg`,
      dataAtual:fmtDate(r.dAtual),
      temp: Number.isFinite(meteo.tmean) ? `${meteo.tmean.toFixed(1)} ¬∞C` : "‚Äî",
      fatorClima:`<span class="pill">${fc.toFixed(2)}</span>`,
      estimado: Number.isFinite(estKg) ? `${estKg.toFixed(1)} kg` : "‚Äî",
      conf, confClass,
      estado, estadoClass,
      bucket,
      estKg
    });

    const g = r.grupo || "‚Äî";
    if(!groupAgg[g]){
      groupAgg[g] = {
        name:g,n:0,m:0,f:0,
        sumPesoM:0,sumPesoF:0,
        sumEstM:0,sumEstF:0,
        sumGmdM:0,sumGmdF:0,
        nGmdM:0,nGmdF:0,
        sumTemp:0,nTemp:0,
        ok:0,warn:0,bad:0
      };
    }
    const ga = groupAgg[g];
    ga.n++;

    const sx = clean(r.sexo).toUpperCase();
    if(sx==="M"){
      ga.m++; ga.sumPesoM += r.pAtual;
      if(Number.isFinite(estKg)) ga.sumEstM += estKg;
    }else if(sx==="F"){
      ga.f++; ga.sumPesoF += r.pAtual;
      if(Number.isFinite(estKg)) ga.sumEstF += estKg;
    }

    if(Number.isFinite(meteo.tmean)){ ga.sumTemp += meteo.tmean; ga.nTemp++; }

    if(Number.isFinite(r.gmdInd)){
      if(sx==="M"){ ga.sumGmdM += r.gmdInd; ga.nGmdM++; }
      else if(sx==="F"){ ga.sumGmdF += r.gmdInd; ga.nGmdF++; }

      if(bucket==="g") ga.ok++;
      else if(bucket==="o") ga.warn++;
      else if(bucket==="r") ga.bad++;
    }
  }

  APP_STATE.groupAgg = groupAgg;

  animalsOut.sort((a,b)=>a.sortKey-b.sortKey || a.grupo.localeCompare(b.grupo) || a.animal.localeCompare(b.animal));

  tbodyAnimals.innerHTML = "";
  for(const a of animalsOut){ renderAnimalRow(a); }

  const groupsOut = Object.values(groupAgg).map(g=>{
    g.avgPesoM = g.m ? g.sumPesoM/g.m : NaN;
    g.avgPesoF = g.f ? g.sumPesoF/g.f : NaN;
    g.avgEstM  = g.m ? g.sumEstM/g.m : NaN;
    g.avgEstF  = g.f ? g.sumEstF/g.f : NaN;

    g.avgGmdM  = g.nGmdM ? g.sumGmdM/g.nGmdM : NaN;
    g.avgGmdF  = g.nGmdF ? g.sumGmdF/g.nGmdF : NaN;
    g.avgTemp  = g.nTemp ? g.sumTemp/g.nTemp : NaN;

    const totalStatus = g.ok + g.warn + g.bad;
    g.risk = totalStatus ? ((g.warn + g.bad) / totalStatus) : 0;
    g.sortKey = (g.bad*1000) + (g.warn*100) - (g.ok*10);
    return g;
  }).sort((a,b)=>b.sortKey-a.sortKey || b.risk-a.risk || a.name.localeCompare(b.name));

  APP_STATE.groupsOut = groupsOut;

  tbodyGroups.innerHTML = "";
  for(const g of groupsOut){ renderGroupRow(g); }

  renderAlerts(groupsOut);

  APP_STATE.loaded = true;
  btnRecalc.disabled = true;
  forecastStatusEl.textContent = "";
  renderForecast();

  statusEl.innerHTML =
    `Separador: <b>${delim}</b> ¬∑ Linhas: <b>${rows.length}</b> ¬∑ Processadas: <b>${okRows}</b> ¬∑ Falhas: <b>${badRows}</b> ¬∑ ` +
    `Meteo: <b>Open-Meteo hist√≥rico</b> ¬∑ Local: <b>${SITE.lat.toFixed(4)}, ${SITE.lon.toFixed(4)}</b>`;
}
</script>

</body>
</html>
