<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Monte do Pasto ‚Äî Dashboard Bovinos</title>

<link rel="stylesheet" href="styles.css">

<style>
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  input[type="file"]{padding:8px;background:#fff;border:1px solid #ccc;border-radius:10px}
  .cards{display:grid;grid-template-columns:1fr;gap:14px}
  .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
  .pill{display:inline-block;padding:2px 10px;border:1px solid #bbb;border-radius:999px;background:#fafafa}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-bottom:10px}
  .controls label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .controls button{
    padding:9px 14px;border-radius:10px;border:1px solid #ccc;background:#eee;
    cursor:pointer;font-weight:700
  }
  .controls button:disabled{opacity:.6;cursor:not-allowed}
  .right{margin-left:auto}

  .alerts-wrap{display:flex;flex-direction:column;gap:6px}
  .alert-row{padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fafafa}
  .alert-row.bad{border-color:#f2b8c0;background:#fff5f6}
  .alert-row.warn{border-color:#ffd7a8;background:#fff8f0}
  .alert-row.ok{border-color:#bfe6c1;background:#f4fff5}

  .stackbar{height:10px;background:#eee;border-radius:999px;overflow:hidden;display:flex}
  .seg{height:100%}
  .g{background:#4caf50}
  .o{background:#ff9800}
  .r{background:#f44336}
  .tag{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #bbb;background:#fff;margin-left:8px}

    .topline{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

  @media print{
    nav, input, button, .bar, .controls, .small{
      display:none !important;
    }

    body{
      background:#fff;
    }

    .card{
      border:1px solid #000;
      box-shadow:none;
    }

    table{
      font-size:12px;
    }

    h1, h2{
      margin-top:0;
    }
  }
</style>
</head>

<body>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="animais.html">Animais</a>
  <a href="planeamento.html">Planeamento</a>
  <a href="ranking.html">Ranking</a>
</nav>

<div class="topline">
  <h1 style="margin:0;">Dashboard Bovinos ‚Äî Monitoriza√ß√£o (Alertas + Resumo)</h1>
  <div class="status right" id="stamp"></div>
</div>

<div class="bar">
  <input type="file" id="fileInput" accept=".csv,text/csv">
  <div class="status" id="status">Carrega o teu <b>efetivo_bovinos.csv</b> (fica guardado at√© carregares outro)</div>
</div>

<div class="cards">

  <div class="card">
    <div class="controls">
      <div>
        <label>A√ß√µes</label>
<div style="display:flex;gap:8px;flex-wrap:wrap">
  <button id="btnExport">Exportar PDF</button>
  <button id="btnClear">Limpar dados (app)</button>
  <button id="btnClearMeteo">Limpar cache meteo</button>
</div>
      </div>
      <div class="right status" id="metaLine"></div>
    </div>

    <div class="small">
      ‚Ä¢ Esta p√°gina √© o <b>painel principal</b>. Carregas o CSV uma vez e depois vais para ‚ÄúAnimais‚Äù e ‚ÄúPlaneamento‚Äù.<br>
      ‚Ä¢ ‚ÄúLimpar dados‚Äù apaga o estado guardado no browser. ‚ÄúLimpar cache meteo‚Äù for√ßa novo download da meteorologia (pode demorar um pouco).
    </div>
  </div>

  <div class="card">
    <h2>Alertas</h2>
    <div id="alerts" class="alerts-wrap"></div>
    <div class="small">
      Regras: üî• <b>Vermelho</b> se üî¥ ‚â• 15% (em animais com 2 pesagens) ¬∑ ‚ö†Ô∏è <b>Amarelo</b> se (üü°+üî¥) ‚â• 30% ¬∑ ‚úî caso contr√°rio.
    </div>
  </div>

  <div class="card">
    <h2>Resumo por Grupo</h2>
    <table>
      <thead>
        <tr>
          <th class="left">Grupo</th>
          <th>Animais</th>
          <th>M</th>
          <th>F</th>
          <th>Peso M (kg)</th>
          <th>Peso F (kg)</th>
          <th>GMD M real</th>
          <th>GMD F real</th>
          <th>Temp. m√©dia (¬∞C)</th>
          <th class="left">Estado do grupo</th>
        </tr>
      </thead>
      <tbody id="tbodyGroups"></tbody>
    </table>
    <div class="small">
      ‚Ä¢ ‚ÄúGMD real‚Äù usa apenas animais com <b>2 pesagens</b> (crescimento observado).<br>
      ‚Ä¢ A barra üü¢üü°üî¥ conta apenas animais com hist√≥rico (2 pesagens).<br>
      ‚Ä¢ Meteorologia: temperatura m√©dia do per√≠odo desde a √∫ltima pesagem (Open-Meteo hist√≥rico). Se falhar/timeout, usa fallback e segue.
    </div>
  </div>

</div>

<script src="core.js"></script>
<script>
(function(){
  const statusEl = document.getElementById("status");
  const stampEl = document.getElementById("stamp");
  const metaLineEl = document.getElementById("metaLine");
  const alertsEl = document.getElementById("alerts");
  const tbodyGroups = document.getElementById("tbodyGroups");

  const btnClear = document.getElementById("btnClear");
  const btnClearMeteo = document.getElementById("btnClearMeteo");
  const fileInput = document.getElementById("fileInput");
  const btnExport = document.getElementById("btnExport");

  function setStamp(state){
    if(!state?.generated_at){
      stampEl.textContent = "";
      return;
    }
    const d = new Date(state.generated_at);
    const when = isFinite(d.getTime()) ? d.toLocaleString("pt-PT") : state.generated_at;
    stampEl.innerHTML = `<span class="pill">√öltima atualiza√ß√£o: <b>${when}</b></span>`;
  }

  function setMetaLine(state){
    if(!state?.meta) { metaLineEl.textContent = ""; return; }
    const m = state.meta;
    const loc = state?.config?.SITE ? `${state.config.SITE.lat.toFixed(4)}, ${state.config.SITE.lon.toFixed(4)}` : "‚Äî";
    metaLineEl.innerHTML =
      `Separador: <b>${m.delimiter || "‚Äî"}</b> ¬∑ Linhas: <b>${m.lines ?? "‚Äî"}</b> ¬∑ ` +
      `Processadas: <b>${m.processed_ok ?? "‚Äî"}</b> ¬∑ Falhas: <b>${m.processed_fail ?? "‚Äî"}</b> ¬∑ ` +
      `Local: <b>${loc}</b>`;
  }

  function renderAlerts(state){
    alertsEl.innerHTML = "";
    const list = Core.buildAlerts(state?.groupsOut || []);

    if(!list.length){
      const div = document.createElement("div");
      div.className = "alert-row ok";
      div.innerHTML = `<b class="ok">‚úî Nenhum alerta ativo</b>`;
      alertsEl.appendChild(div);
      return;
    }

    for(const r of list){
      const div = document.createElement("div");
      div.className = `alert-row ${r.level}`;
      div.innerHTML = `<b class="${r.level}">${Core.escapeHtml(r.text)}</b><div class="small">${Core.escapeHtml(r.meta)}</div>`;
      alertsEl.appendChild(div);
    }
  }

  function renderGroupRow(g){
    const totalStatus = (g.ok||0) + (g.warn||0) + (g.bad||0);
    const green = totalStatus ? ((g.ok||0)/totalStatus)*100 : 0;
    const orange = totalStatus ? ((g.warn||0)/totalStatus)*100 : 0;
    const red = totalStatus ? ((g.bad||0)/totalStatus)*100 : 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="left"><b>${Core.escapeHtml(g.name)}</b></td>
      <td>${g.n ?? 0}</td>
      <td>${g.m ?? 0}</td>
      <td>${g.f ?? 0}</td>
      <td>${Number.isFinite(g.avgPesoM) ? g.avgPesoM.toFixed(1) : "‚Äî"}</td>
      <td>${Number.isFinite(g.avgPesoF) ? g.avgPesoF.toFixed(1) : "‚Äî"}</td>
      <td>${Number.isFinite(g.avgGmdM) ? g.avgGmdM.toFixed(2) : "‚Äî"}</td>
      <td>${Number.isFinite(g.avgGmdF) ? g.avgGmdF.toFixed(2) : "‚Äî"}</td>
      <td>${Number.isFinite(g.avgTemp) ? g.avgTemp.toFixed(1) : "‚Äî"}</td>
      <td class="left">
        <div class="stackbar" title="Distribui√ß√£o do estado (apenas com 2 pesagens)">
          <div class="seg g" style="width:${green}%"></div>
          <div class="seg o" style="width:${orange}%"></div>
          <div class="seg r" style="width:${red}%"></div>
        </div>
        <div style="margin-top:6px" class="mono">
          üü¢ ${g.ok||0} &nbsp; üü° ${g.warn||0} &nbsp; üî¥ ${g.bad||0}
          <span class="muted"> (com hist√≥rico: ${totalStatus})</span>
          <span class="tag">risco ${((g.risk||0)*100).toFixed(0)}%</span>
        </div>
      </td>
    `;
    tbodyGroups.appendChild(tr);
  }

  function renderGroups(state){
    tbodyGroups.innerHTML = "";
    const groups = state?.groupsOut || [];
    if(!groups.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="left muted" colspan="10">Sem dados. Carrega um CSV para come√ßar.</td>`;
      tbodyGroups.appendChild(tr);
      return;
    }
    for(const g of groups) renderGroupRow(g);
  }

  function renderAll(state){
    setStamp(state);
    setMetaLine(state);
    renderAlerts(state);
    renderGroups(state);

    if(!state?.generated_at){
      statusEl.innerHTML = `Carrega o teu <b>efetivo_bovinos.csv</b> (fica guardado at√© carregares outro)`;
    }else{
      statusEl.innerHTML = `Dados carregados e guardados. Podes ir a <b>Animais</b> e <b>Planeamento</b>.`;
    }
  }

  async function importFromFile(file){
    const reader = new FileReader();
    reader.onload = async (ev) => {
      const txt = ev.target.result;

      fileInput.disabled = true;
      btnClear.disabled = true;
      btnClearMeteo.disabled = true;

      statusEl.innerHTML = `A iniciar importa√ß√£o‚Ä¶`;

      try{
        const st = await Core.importCSVText(txt, {
          onProgress: (p) => {
            if(p.phase === "parse"){
              statusEl.innerHTML = `A ler CSV‚Ä¶ <b>${p.done}</b>/<b>${p.total}</b>`;
            }else if(p.phase === "meteo"){
              statusEl.innerHTML = `A pedir meteorologia‚Ä¶ <b>${p.done}</b>/<b>${p.total}</b>`;
            }else{
              statusEl.innerHTML = `A processar‚Ä¶`;
            }
          }
        });

        statusEl.innerHTML = `Importa√ß√£o conclu√≠da ‚úÖ (dados guardados)`;
        renderAll(st);

      }catch(err){
        console.error(err);
        alert("Falha ao importar o CSV. Confirma o formato/colunas.\n\nDetalhe: " + (err?.message || err));
        renderAll(Core.loadState() || null);
      }finally{
        fileInput.disabled = false;
        btnClear.disabled = false;
        btnClearMeteo.disabled = false;
        fileInput.value = "";
      }
    };
    reader.readAsText(file);
  }

  fileInput.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    importFromFile(file);
  });

  btnClear.addEventListener("click", ()=>{
    if(!confirm("Isto vai apagar os dados guardados no browser para esta app. Continuar?")) return;
    Core.clearState();
    renderAll(null);
  });

  btnClearMeteo.addEventListener("click", ()=>{
    if(!confirm("Isto vai apagar a cache de meteorologia. A pr√≥xima importa√ß√£o vai voltar a pedir tudo. Continuar?")) return;
    Core.clearMeteoCache();
    alert("Cache meteo apagada. ‚úÖ");
  });

  // boot
  renderAll(Core.loadState() || null);
})();
</script>

</body>
</html>
