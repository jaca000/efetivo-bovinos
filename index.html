<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Monte do Pasto ‚Äî Dashboard Bovinos</title>
<style>
  :root{
    --bg:#f4f5f2; --card:#fff; --line:#ddd; --muted:#666;
    --ok:#2e7d32; --warn:#f57c00; --bad:#b00020;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);margin:0;padding:18px;color:#222}
  h1{margin:0 0 10px;font-size:18px}
  h2{margin:0 0 10px;font-size:15px}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  input[type="file"]{padding:8px;background:#fff;border:1px solid #ccc;border-radius:10px}
  .status{font-size:13px;color:var(--muted)}
  .cards{display:grid;grid-template-columns:1fr;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  table{border-collapse:collapse;width:100%;background:#fff}
  th,td{border:1px solid #ccc;padding:8px;text-align:center;font-size:13px}
  th{background:#eee;position:sticky;top:0}
  .ok{color:var(--ok);font-weight:900}
  .warn{color:var(--warn);font-weight:900}
  .bad{color:var(--bad);font-weight:900}
  .muted{color:var(--muted)}
  .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
  .pill{display:inline-block;padding:2px 10px;border:1px solid #bbb;border-radius:999px;background:#fafafa}
  .stackbar{height:10px;background:#eee;border-radius:999px;overflow:hidden;display:flex}
  .seg{height:100%}
  .g{background:#4caf50}
  .o{background:#ff9800}
  .r{background:#f44336}
  .left{text-align:left}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
</style>
</head>
<body>

<h1>Dashboard Bovinos ‚Äî An√°lise de Grupos (M/F)</h1>

<div class="bar">
  <input type="file" id="fileInput" accept=".csv,text/csv">
  <div class="status" id="status">Carrega o teu <b>efetivo_bovinos.csv</b></div>
</div>

<div class="cards">
  <div class="card">
    <h2>Resumo por Grupo</h2>
    <table>
      <thead>
        <tr>
          <th class="left">Grupo</th>
          <th>Animais</th>
          <th>M</th>
          <th>F</th>
          <th>Peso M (kg)</th>
          <th>Peso F (kg)</th>
          <th>GMD M real</th>
          <th>GMD F real</th>
          <th>Temp. m√©dia (¬∞C)</th>
          <th>Estado do grupo</th>
        </tr>
      </thead>
      <tbody id="tbodyGroups"></tbody>
    </table>
    <div class="small">
      ‚Ä¢ ‚ÄúGMD real‚Äù usa apenas animais com <b>2 pesagens</b> (crescimento observado).<br>
      ‚Ä¢ Barra üü¢üü°üî¥ conta apenas animais com hist√≥rico (2 pesagens).<br>
      ‚Ä¢ Meteorologia: temperatura m√©dia do per√≠odo desde a √∫ltima pesagem (Open-Meteo hist√≥rico). Se falhar, usa fator conservador.
    </div>
  </div>

  <div class="card">
    <h2>Detalhe por Animal</h2>
    <table>
      <thead>
        <tr>
          <th class="left">Animal</th>
          <th class="left">Grupo</th>
          <th>Sexo</th>
          <th>Peso atual</th>
          <th>Data peso</th>
          <th>Temp. per√≠odo</th>
          <th>Fator clima</th>
          <th>Peso estimado hoje</th>
          <th>Confian√ßa</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="tbodyAnimals"></tbody>
    </table>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const SITE = { lat: 38.17355612872988, lon: -7.986520046258665 };

/* Estado (compara GMD REAL do animal vs m√©dia REAL do grupo) */
function performanceStatus(gmdInd, gmdMediaGrupo){
  if(!Number.isFinite(gmdInd) || !Number.isFinite(gmdMediaGrupo) || gmdMediaGrupo<=0)
    return ["‚Äî (sem hist√≥rico)","muted", 9, "none"];
  const r = gmdInd / gmdMediaGrupo;
  if(r >= 0.95) return ["üü¢ Normal","ok", 3, "g"];
  if(r >= 0.80) return ["üü° A vigiar","warn", 2, "o"];
  return ["üî¥ Atrasado","bad", 1, "r"];
}

/* Confian√ßa pelo tempo desde √∫ltima pesagem */
function confidenceByDays(days){
  if(!Number.isFinite(days)) return ["‚Äî","muted"];
  if(days < 14) return ["Alta","ok"];
  if(days < 35) return ["M√©dia","warn"];
  return ["Baixa","bad"];
}

/* Ajustes (usados s√≥ na estimativa de peso) */
function factorSexo(sexo){ return (clean(sexo).toUpperCase()==="F") ? 0.92 : 1.00; }
function factorMaturidade(peso, sexo){
  const s = clean(sexo).toUpperCase();
  const limiar = (s==="F") ? 460 : 520;
  if(peso < limiar) return 1.00;
  if(peso < limiar + 60) return 0.90;
  return 0.80;
}

/* ===================== HELPERS ===================== */
function clean(s){ return String(s ?? "").trim(); }
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function parseNumber(x){
  x = clean(x);
  if(!x) return NaN;
  x = x.replace(",", ".");
  const n = parseFloat(x);
  return Number.isFinite(n) ? n : NaN;
}
/* datas: YYYY-MM-DD, DD-MM-YYYY, DD/MM/YYYY (UTC) */
function parseDatePT(s){
  s = clean(s);
  if(!s) return null;

  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    const dt = new Date(Date.UTC(y, mo-1, d));
    return Number.isFinite(dt.getTime()) ? dt : null;
  }

  m = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if(m){
    const d=+m[1], mo=+m[2], y=+m[3];
    const dt = new Date(Date.UTC(y, mo-1, d));
    return Number.isFinite(dt.getTime()) ? dt : null;
  }

  return null;
}
function fmtDate(d){
  if(!d) return "‚Äî";
  const dd = String(d.getUTCDate()).padStart(2,"0");
  const mm = String(d.getUTCMonth()+1).padStart(2,"0");
  const yy = d.getUTCFullYear();
  return `${dd}-${mm}-${yy}`;
}
function daysBetweenUTC(a,b){
  if(!a || !b) return NaN;
  const ms = b.getTime() - a.getTime();
  return Math.floor(ms / (1000*60*60*24));
}
function detectDelimiter(text){
  const first = (text.split(/\r?\n/)[0] || "");
  const semi = (first.match(/;/g)||[]).length;
  const comma = (first.match(/,/g)||[]).length;
  return semi >= comma ? ";" : ",";
}
function isoDateUTC(d){
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth()+1).padStart(2,"0");
  const da = String(d.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

/* ===================== METEO (Open-Meteo hist√≥rico) ===================== */
const meteoCache = new Map(); // key start|end -> {tmean, factor}

function factorFromTempMean(t){
  if(!Number.isFinite(t)) return 0.95;
  if(t <= 20) return 1.00;
  if(t <= 25) return 0.95;
  if(t <= 30) return 0.85;
  return 0.70;
}

async function getTempMeanForPeriod(startUTC, endUTC){
  const start = isoDateUTC(startUTC);
  const end = isoDateUTC(endUTC);
  const key = `${start}|${end}`;
  if(meteoCache.has(key)) return meteoCache.get(key);

  const url =
    `https://archive-api.open-meteo.com/v1/archive` +
    `?latitude=${SITE.lat}&longitude=${SITE.lon}` +
    `&start_date=${start}&end_date=${end}` +
    `&daily=temperature_2m_mean` +
    `&timezone=auto`;

  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    const temps = j?.daily?.temperature_2m_mean || [];
    if(!temps.length){
      const pack = { tmean: NaN, factor: 0.95 };
      meteoCache.set(key, pack);
      return pack;
    }
    const tmean = temps.reduce((a,b)=>a+b,0)/temps.length;
    const pack = { tmean, factor: factorFromTempMean(tmean) };
    meteoCache.set(key, pack);
    return pack;
  }catch(err){
    const pack = { tmean: NaN, factor: 0.95 };
    meteoCache.set(key, pack);
    return pack;
  }
}

/* ===================== UI ===================== */
const statusEl = document.getElementById("status");
const tbodyGroups = document.getElementById("tbodyGroups");
const tbodyAnimals = document.getElementById("tbodyAnimals");

document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => processCSV(ev.target.result);
  reader.readAsText(file);
});

function renderGroupRow(g){
  const totalStatus = g.ok + g.warn + g.bad;
  const green = totalStatus ? (g.ok/totalStatus)*100 : 0;
  const orange = totalStatus ? (g.warn/totalStatus)*100 : 0;
  const red = totalStatus ? (g.bad/totalStatus)*100 : 0;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="left"><b>${escapeHtml(g.name)}</b></td>
    <td>${g.n}</td>
    <td>${g.m}</td>
    <td>${g.f}</td>
    <td>${Number.isFinite(g.avgPesoM) ? g.avgPesoM.toFixed(1) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgPesoF) ? g.avgPesoF.toFixed(1) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgGmdM) ? g.avgGmdM.toFixed(2) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgGmdF) ? g.avgGmdF.toFixed(2) : "‚Äî"}</td>
    <td>${Number.isFinite(g.avgTemp) ? g.avgTemp.toFixed(1) : "‚Äî"}</td>
    <td class="left">
      <div class="stackbar" title="Distribui√ß√£o do estado (apenas com 2 pesagens)">
        <div class="seg g" style="width:${green}%"></div>
        <div class="seg o" style="width:${orange}%"></div>
        <div class="seg r" style="width:${red}%"></div>
      </div>
      <div style="margin-top:6px" class="mono">
        üü¢ ${g.ok} &nbsp; üü° ${g.warn} &nbsp; üî¥ ${g.bad}
        <span class="muted"> (com hist√≥rico: ${totalStatus})</span>
      </div>
    </td>
  `;
  tbodyGroups.appendChild(tr);
}

function renderAnimalRow(a){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="left">${escapeHtml(a.animal)}</td>
    <td class="left">${escapeHtml(a.grupo)}</td>
    <td>${escapeHtml(a.sexo)}</td>
    <td>${escapeHtml(a.pesoAtual)}</td>
    <td>${escapeHtml(a.dataAtual)}</td>
    <td>${escapeHtml(a.temp)}</td>
    <td>${a.fatorClima}</td>
    <td><b>${escapeHtml(a.estimado)}</b></td>
    <td class="${a.confClass}">${escapeHtml(a.conf)}</td>
    <td class="${a.estadoClass}">${escapeHtml(a.estado)}</td>
  `;
  tbodyAnimals.appendChild(tr);
}

/* ===================== MAIN ===================== */
async function processCSV(csvText){
  tbodyGroups.innerHTML = "";
  tbodyAnimals.innerHTML = "";
  meteoCache.clear();

  const delim = detectDelimiter(csvText);
  const lines = csvText.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(lines.length < 2){
    alert("CSV vazio ou inv√°lido.");
    return;
  }

  const now = new Date();
  const todayUTC = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));

  const header = lines[0].split(delim).map(clean);
  const idx = (name) => header.indexOf(name);

  const i_animal = idx("animal_id") >= 0 ? idx("animal_id") : 0;
  const i_sexo   = idx("sexo") >= 0 ? idx("sexo") : 2;
  const i_grupo  = idx("grupo") >= 0 ? idx("grupo") : 3;
  const i_dant   = idx("data_peso_anterior") >= 0 ? idx("data_peso_anterior") : 4;
  const i_pant   = idx("peso_anterior") >= 0 ? idx("peso_anterior") : 5;
  const i_datual = idx("data_peso_atual") >= 0 ? idx("data_peso_atual") : 6;
  const i_patual = idx("peso_atual") >= 0 ? idx("peso_atual") : 7;

  const rows = [];
  const gmdIndSamples = {}; // grupo -> [gmdInd]

  for(let li=1; li<lines.length; li++){
    const cols = lines[li].split(delim);

    const animal = clean(cols[i_animal]) || "‚Äî";
    const sexo   = clean(cols[i_sexo]).toUpperCase() || "‚Äî";
    const grupo  = clean(cols[i_grupo]) || "‚Äî";

    const dAnt   = parseDatePT(cols[i_dant]);
    const pAnt   = parseNumber(cols[i_pant]);
    const dAtual = parseDatePT(cols[i_datual]);
    const pAtual = parseNumber(cols[i_patual]);

    let gmdInd = NaN;
    if(dAnt && dAtual && Number.isFinite(pAnt) && Number.isFinite(pAtual)){
      const d = daysBetweenUTC(dAnt, dAtual);
      if(Number.isFinite(d) && d > 0){
        gmdInd = (pAtual - pAnt) / d;
        if(Number.isFinite(gmdInd)){
          (gmdIndSamples[grupo] ||= []).push(gmdInd);
        }
      }
    }

    rows.push({animal, sexo, grupo, dAnt, pAnt, dAtual, pAtual, gmdInd});
  }

  const gmdMediaGrupo = {};
  for(const r of rows){
    const g = r.grupo || "‚Äî";
    if(gmdMediaGrupo[g] == null){
      const arr = gmdIndSamples[g] || [];
      gmdMediaGrupo[g] = arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : NaN;
    }
  }

  const DEFAULT_GMD = 1.4;
  const gmdEstimativaGrupo = {};
  for(const r of rows){
    const g = r.grupo || "‚Äî";
    if(gmdEstimativaGrupo[g] == null){
      const arr = gmdIndSamples[g] || [];
      gmdEstimativaGrupo[g] = arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : DEFAULT_GMD;
    }
  }

  statusEl.innerHTML = `Separador: <b>${delim}</b> ¬∑ Linhas: <b>${rows.length}</b> ¬∑ A pedir meteorologia‚Ä¶`;

  const periodKeys = new Set();
  for(const r of rows){
    if(r.dAtual){
      periodKeys.add(`${isoDateUTC(r.dAtual)}|${isoDateUTC(todayUTC)}`);
    }
  }

  await Promise.all([...periodKeys].map(async key=>{
    const [s,e] = key.split("|");
    const sD = new Date(Date.UTC(+s.slice(0,4), +s.slice(5,7)-1, +s.slice(8,10)));
    const eD = new Date(Date.UTC(+e.slice(0,4), +e.slice(5,7)-1, +e.slice(8,10)));
    await getTempMeanForPeriod(sD, eD);
  }));

  const animalsOut = [];
  const groupAgg = {}; // grupo -> stats

  let ok=0, bad=0;

  for(const r of rows){
    const hasAtual = r.dAtual && Number.isFinite(r.pAtual);
    if(!hasAtual){
      bad++;
      animalsOut.push({
        sortKey: 99,
        animal:r.animal, grupo:r.grupo, sexo:r.sexo,
        pesoAtual:"‚Äî", dataAtual:"‚Äî",
        temp:"‚Äî", fatorClima:`<span class="pill">‚Äî</span>`,
        estimado:"‚Äî",
        conf:"‚Äî", confClass:"muted",
        estado:"‚Äî", estadoClass:"muted",
        bucket:"none",
        tempMean: NaN
      });
      continue;
    }

    const daysSince = daysBetweenUTC(r.dAtual, todayUTC);
    const [conf, confClass] = confidenceByDays(daysSince);

    const meteo = await getTempMeanForPeriod(r.dAtual, todayUTC);
    const fc = meteo.factor;

    const gmdBase = Number.isFinite(r.gmdInd) ? r.gmdInd : (gmdEstimativaGrupo[r.grupo] ?? DEFAULT_GMD);
    const gmdFinal = gmdBase * factorSexo(r.sexo) * factorMaturidade(r.pAtual, r.sexo) * fc;
    const est = r.pAtual + (gmdFinal * daysSince);

    const [estado, estadoClass, estadoSort, bucket] = performanceStatus(r.gmdInd, gmdMediaGrupo[r.grupo]);

    ok++;

    animalsOut.push({
      sortKey: estadoSort,
      animal:r.animal, grupo:r.grupo, sexo:r.sexo,
      pesoAtual:`${r.pAtual.toFixed(1)} kg`,
      dataAtual:fmtDate(r.dAtual),
      temp: Number.isFinite(meteo.tmean) ? `${meteo.tmean.toFixed(1)} ¬∞C` : "‚Äî",
      fatorClima:`<span class="pill">${fc.toFixed(2)}</span>`,
      estimado: Number.isFinite(est) ? `${est.toFixed(1)} kg` : "‚Äî",
      conf, confClass,
      estado, estadoClass,
      bucket,
      tempMean: meteo.tmean
    });

    const g = r.grupo || "‚Äî";
    if(!groupAgg[g]){
      groupAgg[g] = {
        name:g,
        n:0,

        // sexo
        m:0,f:0,

        // pesos
        sumPesoM:0,sumPesoF:0,

        // gmd real por sexo
        sumGmdM:0,sumGmdF:0,
        nGmdM:0,nGmdF:0,

        // temperatura
        sumTemp:0,nTemp:0,

        // estados
        ok:0,warn:0,bad:0
      };
    }
    const ga = groupAgg[g];
    ga.n++;

    const sx = clean(r.sexo).toUpperCase();
    if(sx==="M"){ ga.m++; ga.sumPesoM += r.pAtual; }
    else if(sx==="F"){ ga.f++; ga.sumPesoF += r.pAtual; }

    if(Number.isFinite(meteo.tmean)){ ga.sumTemp += meteo.tmean; ga.nTemp++; }

    // s√≥ contar estado/gmd real se houver gmdInd real
    if(Number.isFinite(r.gmdInd)){
      if(sx==="M"){ ga.sumGmdM += r.gmdInd; ga.nGmdM++; }
      else if(sx==="F"){ ga.sumGmdF += r.gmdInd; ga.nGmdF++; }

      if(bucket==="g") ga.ok++;
      else if(bucket==="o") ga.warn++;
      else if(bucket==="r") ga.bad++;
    }
  }

  animalsOut.sort((a,b)=>a.sortKey-b.sortKey || a.grupo.localeCompare(b.grupo) || a.animal.localeCompare(b.animal));

  tbodyAnimals.innerHTML = "";
  for(const a of animalsOut){
    renderAnimalRow(a);
  }

  const groupsOut = Object.values(groupAgg).map(g=>{
    g.avgPesoM = g.m ? g.sumPesoM/g.m : NaN;
    g.avgPesoF = g.f ? g.sumPesoF/g.f : NaN;
    g.avgGmdM  = g.nGmdM ? g.sumGmdM/g.nGmdM : NaN;
    g.avgGmdF  = g.nGmdF ? g.sumGmdF/g.nGmdF : NaN;
    g.avgTemp  = g.nTemp ? g.sumTemp/g.nTemp : NaN;

    g.histCount = g.ok + g.warn + g.bad;
    g.sortKey = (g.bad*1000) + (g.warn*100) - (g.ok*10);
    return g;
  }).sort((a,b)=>b.sortKey-a.sortKey || a.name.localeCompare(b.name));

  tbodyGroups.innerHTML = "";
  for(const g of groupsOut){
    renderGroupRow(g);
  }

  statusEl.innerHTML =
    `Separador: <b>${delim}</b> ¬∑ Linhas: <b>${rows.length}</b> ¬∑ Processadas: <b>${ok}</b> ¬∑ Falhas: <b>${bad}</b> ¬∑ ` +
    `Meteo: <b>Open-Meteo hist√≥rico</b> ¬∑ Local: <b>${SITE.lat.toFixed(4)}, ${SITE.lon.toFixed(4)}</b>`;
}
</script>

</body>
</html>
